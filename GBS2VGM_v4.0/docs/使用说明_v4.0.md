# GBS2VGM v4.0 使用说明

## 📖 目录

1. [快速开始](#快速开始)
2. [详细使用](#详细使用)
3. [工具说明](#工具说明)
4. [常见问题](#常见问题)
5. [高级用法](#高级用法)

---

## 快速开始

### 最简单的使用方式

```bash
# 1. 解压发布包
tar -xzf GBS2VGM_v4.0.tar.gz
cd GBS2VGM_v4.0

# 2. 处理VGM文件（假设你已经有VGM文件）
./scripts/process_vgm_with_log.sh <文件夹名称>
```

### 完整流程示例

```bash
# 1. 转换GBS到VGM
./bin/gbs2vgm_batch.exe "path/to/game.m3u" "output_folder"

# 2. 处理VGM文件（检测循环点并修剪）
./scripts/process_vgm_with_log.sh output_folder

# 3. 查看处理结果
cat working/output_folder_VGM_process.log
```

---

## 详细使用

### 步骤1: 准备GBS文件

GBS文件通常包含在游戏ROM的压缩包中。

**示例文件结构：**
```
Dragon Quest III.7z
└── Dragon Quest III/
    ├── DMG-XXXX-JPN.gbs
    └── DMG-XXXX-JPN.m3u
```

### 步骤2: 转换GBS到VGM

使用`gbs2vgm_batch.exe`将GBS文件转换为VGM格式：

```bash
./bin/gbs2vgm_batch.exe "path/to/game.m3u" "output_folder"
```

**参数说明：**
- 第一个参数：M3U播放列表文件路径
- 第二个参数：输出目录名称

**输出：**
- 在`working/output_folder/`目录下生成多个VGM文件
- 每个子曲目对应一个VGM文件

### 步骤3: 检测循环点并修剪

#### 方式A: 使用自动化脚本（推荐）

```bash
./scripts/process_vgm_with_log.sh output_folder
```

**脚本功能：**
1. 自动检测每个VGM文件的循环点
2. 根据循环点修剪文件
3. 生成详细的处理日志
4. 将修剪后的文件覆盖回原目录

**输出文件：**
- `working/output_folder_VGM_process.log` - 详细处理日志
- `working/output_folder_VGM_progress.txt` - 进度文件

#### 方式B: 手动处理

```bash
# 1. 检测循环点
cd working/output_folder
echo "filename.vgm" | ../../gbsplay/vgmlpfnd.exe -silent

# 2. 修剪文件
../../bin/vgm_trim.exe input.vgm 0 <loop_start> <loop_end> output.vgm

# 3. 替换原文件
mv output.vgm input.vgm
```

---

## 工具说明

### gbs2vgm_batch.exe

**功能：** 批量转换GBS文件到VGM格式

**用法：**
```bash
./bin/gbs2vgm_batch.exe <m3u_file> <output_dir>
```

**特性：**
- 支持M3U播放列表
- 自动处理多个子曲目
- 默认3倍长度用于循环检测
- 自动创建输出目录

**示例：**
```bash
./bin/gbs2vgm_batch.exe "Dragon Quest III/game.m3u" "DQ3_VGM"
```

### vgmlpfnd.exe

**功能：** 智能循环点检测工具

**用法：**
```bash
echo "filename.vgm" | ./gbsplay/vgmlpfnd.exe -silent
```

**输出格式：**
```
Source  Time      Target  Time      Cmds
12345   0:12.34 ! 67890   0:45.67   12345
```

**标记说明：**
- `!` - 最佳循环点（推荐使用）
- `e` - 文件结尾
- 无标记 - 候选循环点

**示例输出：**
```
Source  Time      Target  Time      Cmds
953     0:00.21 ! 1096704 0:24.60   40888
```

### vgm_trim.exe

**功能：** VGM文件修剪工具

**用法：**
```bash
./bin/vgm_trim.exe <input.vgm> <trim_start> <loop_start> <loop_end> <output.vgm>
```

**参数说明：**
- `input.vgm` - 输入VGM文件
- `trim_start` - 修剪起始位置（通常为0）
- `loop_start` - 循环起始位置
- `loop_end` - 循环结束位置
- `output.vgm` - 输出VGM文件

**示例：**
```bash
./bin/vgm_trim.exe input.vgm 0 953 1096704 output.vgm
```

### process_vgm_with_log.sh

**功能：** 带详细日志的VGM处理脚本

**用法：**
```bash
./scripts/process_vgm_with_log.sh <folder_name>
```

**处理流程：**
1. 检测所有VGM文件的循环点
2. 自动选择最佳循环点
3. 修剪VGM文件
4. 生成详细日志
5. 合并文件到原目录

**日志文件：**
- `working/<folder>_VGM_process.log` - 完整处理日志
- `working/<folder>_VGM_progress.txt` - 实时进度

**示例：**
```bash
./scripts/process_vgm_with_log.sh DQ3
```

---

## 常见问题

### Q1: 为什么有些文件无法修剪？

**A:** 有些VGM文件可能：
- 没有明显的循环点
- 是单次播放的音效或短曲
- 循环结构不规则

这些文件会被跳过，保留原文件。

### Q2: 修剪后音质会下降吗？

**A:** 不会。修剪只是删除多余的循环数据，不改变音频内容和质量。

### Q3: 如何选择最佳循环点？

**A:** 脚本会自动选择：
1. 优先选择标记为"!"的循环点（最佳）
2. 如果没有"!"标记，选择持续时间最长的循环点

### Q4: 处理失败怎么办？

**A:** 检查：
1. 输入文件是否存在
2. 文件路径是否包含特殊字符
3. 磁盘空间是否充足
4. 查看日志文件了解详细错误

### Q5: 可以批量处理多个游戏吗？

**A:** 可以！依次运行：
```bash
./scripts/process_vgm_with_log.sh DQ3
./scripts/process_vgm_with_log.sh DQM1
./scripts/process_vgm_with_log.sh DQM2
```

---

## 高级用法

### 自定义循环次数

修改`gbs2vgm_batch.c`中的`LOOP_COUNT`常量：

```c
#define LOOP_COUNT 3  // 改为你想要的循环次数
```

然后重新编译：
```bash
make clean
make
```

### 并行处理（实验性）

使用多线程脚本加速处理：

```bash
./scripts/process_vgm_parallel.sh DQ3 8  # 使用8线程
```

**注意：** 多线程处理可能不稳定，建议先使用单线程版本。

### 批量处理脚本

创建自己的批量处理脚本：

```bash
#!/bin/bash
for folder in DQ3 DQM1 DQM2 Tales; do
    echo "处理 $folder..."
    ./scripts/process_vgm_with_log.sh $folder
done
```

### 自定义输出格式

修改脚本中的日志格式：

```bash
# 在 process_vgm_with_log.sh 中
echo "自定义日志: $filename" | tee -a "$LOG_FILE"
```

---

## 性能优化建议

### 1. 使用SSD存储

将工作目录放在SSD上可以显著提升处理速度。

### 2. 关闭实时杀毒

处理大量文件时，临时关闭实时杀毒可以提升性能。

### 3. 增加系统内存

处理大型VGM文件时，充足的内存可以避免频繁的磁盘交换。

### 4. 批量处理

一次性处理多个文件夹比逐个处理更高效。

---

## 故障排除

### 问题：脚本无法执行

**解决方案：**
```bash
chmod +x scripts/*.sh
```

### 问题：找不到可执行文件

**解决方案：**
确保在GBS2VGM_v4.0目录下运行脚本：
```bash
cd GBS2VGM_v4.0
./scripts/process_vgm_with_log.sh DQ3
```

### 问题：处理卡住不动

**解决方案：**
1. 检查进度文件：`cat working/<folder>_VGM_progress.txt`
2. 查看日志文件：`tail -f working/<folder>_VGM_process.log`
3. 如果确实卡住，按Ctrl+C终止，然后重新运行

### 问题：输出文件损坏

**解决方案：**
1. 检查原始VGM文件是否完整
2. 确保磁盘空间充足
3. 尝试重新转换GBS文件

---

## 技术支持

如有问题，请：
1. 查看日志文件了解详细错误
2. 检查本文档的常见问题部分
3. 提交Issue到项目仓库

---

**最后更新**: 2026-02-05
**版本**: v4.0
**作者**: Claude Sonnet 4.5 & Denjhang
