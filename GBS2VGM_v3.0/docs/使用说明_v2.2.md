# GBS2VGM v2.2 - 完整转换流程说明

## 当前状态

✅ **已完成**:
1. 修复了整数溢出bug - 长曲目现在可以正确转换
2. 创建了Makefile - 使用`make`命令编译
3. 支持M3U旧格式 - 兼容现有的DQ M3U文件
4. 自动检测循环曲目 - 根据loop_count自动录制3倍长度
5. 集成vgmlpfnd - 自动检测循环点

⏳ **进行中**:
- Dragon Quest I & II 转换 (12/49 完成)

🔜 **待实现**:
- VGM文件自动修剪
- 循环点自动设置

## 使用流程

### 1. 编译程序

```bash
cd /d/working/vscode-projects/modizer-libs/gbsplay
make
```

### 2. 转换GBS到VGM

```bash
# 自动转换DQ1&2
./convert_dq12.sh

# 或手动转换
./gbs2vgm_batch.exe "path/to/file.m3u" "output_dir"
```

### 3. 检测循环点

转换完成后,脚本会自动运行vgmlpfnd检测循环点,并生成报告:
- 输出目录: `DQ12_VGM_v2.2/`
- 循环点报告: `DQ12_VGM_v2.2/loop_report.txt`

### 4. 查看结果

```bash
# 查看VGM文件信息
./vgm_parser.exe "DQ12_VGM_v2.2/04 [DQ I] Ladutorm Castle.vgm"

# 查看循环点报告
cat DQ12_VGM_v2.2/loop_report.txt
```

## 关键修复说明

### 问题: 某些曲目转换失败,生成空VGM文件

**原因**: 整数溢出
- 对于循环曲目,需要录制 `duration × 3` 的长度
- 例如: 231秒 × 4194304 Hz × 3 = 2,906,652,672
- 这个数字超过了32位有符号整数的最大值 (2,147,483,647)
- 导致`target_cycles`变成负数,循环立即退出

**解决方案**:
```c
// 修改前 (错误)
long target_cycles = entry->duration_sec * GB_CLOCK * render_loops;

// 修改后 (正确)
cycles_t target_cycles = (cycles_t)entry->duration_sec * GB_CLOCK * render_loops;
// cycles_t = uint64_t, 最大值: 18,446,744,073,709,551,615
```

### 问题: 静音检测导致某些曲目提前终止

**解决方案**: 禁用静音检测
```c
static long silence_timeout = 0;  // 0 = 禁用
```

## 循环检测原理

### 为什么录制3倍长度?

1. **第1次播放**: 完整的intro + loop
2. **第2次播放**: 重复的loop
3. **第3次播放**: 再次重复的loop

vgmlpfnd通过比较这3次播放,找到重复的命令序列,从而确定:
- 循环开始位置
- 循环结束位置
- 循环长度

### vgmlpfnd输出示例

```
Source Block		  Block Copy		Copy Information
Start	  Time		Start	  Time		Cmds	Time
24496	00:00.56	5114858	01:55.98	5110	00:21.33  <- 第1次重复
24496	00:00.56	10205215	03:51.41	5110	00:21.33  <- 第2次重复
24496	00:00.56	15295605	05:46.84	5110	00:21.33  <- 第3次重复
1061612	00:24.07  !	6151996	02:19.50	147219	09:11.73  <- 最佳循环点
```

标记`!`的行是最佳循环点:
- **循环开始**: 样本位置 1061612 (时间 00:24.07)
- **循环结束**: 样本位置 6151996 (时间 02:19.50)
- **循环长度**: 147219个命令 (时间 09:11.73)

## 当前限制

1. **文件大小**: VGM文件包含3倍长度的数据
   - 实际播放时间: 3:51 (231秒)
   - 录制时间: 11:33 (693秒)
   - 文件大小: 约822KB (应该是约274KB)

2. **手动修剪**: 需要手动使用循环点信息修剪VGM文件
   - 工具: `vgm_trim.c` (待完成)
   - 或使用其他VGM编辑工具

3. **循环点未设置**: VGM文件头部的循环偏移未设置
   - 播放器会播放完整的3倍长度
   - 需要手动设置循环点

## 下一步工作

### 短期 (v2.3)
1. 完成`vgm_trim.c` - VGM修剪工具
2. 集成到`gbs2vgm_batch` - 自动修剪
3. 自动设置VGM循环点

### 中期 (v3.0)
1. 改进循环检测算法
2. 支持自定义循环检测参数
3. 添加GUI界面

### 长期
1. 支持其他游戏音乐格式 (NSF, SPC, etc.)
2. 批量转换优化
3. 云端转换服务

## 测试结果

### Dragon Quest I & II

| 曲目 | 时长 | 循环 | 文件大小 | 状态 |
|------|------|------|----------|------|
| 01 Overture March (intro) | 0:09 | 否 | 16KB | ✅ |
| 02 Overture March | 1:29 | 否 | 106KB | ✅ |
| 03 People of the Town | 1:12 | 是 | 287KB | ✅ |
| 04 Ladutorm Castle | 3:51 | 是 | 822KB | ✅ |
| 05 People of the Town | 2:51 | 是 | 689KB | ✅ |
| 06 Go Out on the Plain | 2:04 | 是 | 268KB | ✅ |
| ... | ... | ... | ... | ⏳ |

## 常见问题

### Q: 为什么有些文件很大?
A: 循环曲目录制了3倍长度用于循环检测。后续版本会自动修剪。

### Q: 如何手动修剪VGM文件?
A: 使用vgm_trim工具(待完成)或其他VGM编辑器,根据loop_report.txt中的循环点信息修剪。

### Q: 播放器能正确播放吗?
A: 可以播放,但会播放完整的3倍长度。需要设置循环点才能正确循环。

### Q: Bank警告是什么?
A: 某些GBS文件会访问超出范围的ROM bank,这是正常的,不影响转换。

## 联系方式

- GitHub Issues: (待添加)
- Email: (待添加)

## 致谢

- gbsplay项目
- vgmtools项目
- Game Music Emu (GME)
- 所有测试用户

---

**最后更新**: 2026-02-04
**版本**: v2.2
**状态**: 开发中
